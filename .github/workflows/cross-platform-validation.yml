name: Cross-Platform Validation

on:
  schedule:
    # Run comprehensive cross-platform tests weekly
    - cron: "0 6 * * 1"
  workflow_dispatch:
    inputs:
      test_type:
        description: "Type of cross-platform test to run"
        required: true
        default: "full"
        type: choice
        options:
          - full
          - quick
          - targets-only

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  cross-compile-targets:
    name: Cross-Compile Validation
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux targets
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            cross: true
          - os: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            cross: true

          # Windows targets
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            cross: false
          - os: windows-latest
            target: i686-pc-windows-msvc
            cross: false

          # macOS targets
          - os: macos-latest
            target: x86_64-apple-darwin
            cross: false
          - os: macos-latest
            target: aarch64-apple-darwin
            cross: false

          # Additional targets for broader compatibility
          - os: ubuntu-latest
            target: x86_64-unknown-freebsd
            cross: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install musl tools (Linux musl)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Install cross (for cross-compilation)
        if: matrix.cross == true
        run: cargo install cross --locked

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build for target (native)
        if: matrix.cross == false
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build for target (cross-compile)
        if: matrix.cross == true
        run: cross build --release --target ${{ matrix.target }}

      - name: Run tests (native only)
        if: matrix.cross == false && (inputs.test_type || 'full') != 'targets-only'
        run: cargo test --target ${{ matrix.target }} --verbose

      - name: Verify binary functionality (native)
        if: matrix.cross == false
        shell: bash
        run: |
          binary_path="target/${{ matrix.target }}/release/batless"
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            binary_path="${binary_path}.exe"
          fi

          # Test basic functionality
          $binary_path --version
          echo "fn main() { println!(\"test\"); }" | $binary_path --mode=plain --max-lines=1 /dev/stdin || echo "stdin test skipped"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: batless-${{ matrix.target }}
          path: |
            target/${{ matrix.target }}/release/batless*
          retention-days: 7

  platform-specific-tests:
    name: Platform-Specific Tests
    runs-on: ${{ matrix.os }}
    if: (inputs.test_type || 'full') != 'targets-only'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            shell: bash
            path_separator: ":"
            binary_extension: ""
          - os: windows-latest
            shell: pwsh
            path_separator: ";"
            binary_extension: ".exe"
          - os: macos-latest
            shell: bash
            path_separator: ":"
            binary_extension: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release

      - name: Test file path handling
        shell: ${{ matrix.shell }}
        run: |
          # Create test files with platform-specific paths
          mkdir -p "test dir/sub dir"
          echo "test content" > "test dir/sub dir/test file.txt"

          # Test handling of spaces in filenames
          ./target/release/batless${{ matrix.binary_extension }} "test dir/sub dir/test file.txt" --mode=plain --max-lines=1

      - name: Test config file discovery (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          # Test XDG config directory
          mkdir -p ~/.config/batless
          echo 'max_lines = 42' > ~/.config/batless/config.toml

          # Test that config is discovered
          result=$(./target/release/batless${{ matrix.binary_extension }} README.md --mode=json --max-lines=1 | jq -r '.metadata.total_lines')
          echo "Config discovery test passed (result: $result)"

          # Cleanup
          rm -rf ~/.config/batless

      - name: Test config file discovery (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # Test Windows AppData config
          $configDir = "$env:APPDATA\batless"
          New-Item -ItemType Directory -Force -Path $configDir
          'max_lines = 42' | Out-File -FilePath "$configDir\config.toml" -Encoding utf8

          # Test that config is discovered
          $result = & ".\target\release\batless.exe" README.md --mode=json --max-lines=1 | ConvertFrom-Json
          Write-Host "Config discovery test passed"

          # Cleanup
          Remove-Item -Recurse -Force $configDir

      - name: Test Unicode and encoding handling
        shell: ${{ matrix.shell }}
        run: |
          # Create files with various encodings
          echo "Hello, ä¸–ç•Œ! ðŸ¦€" > unicode_test.txt

          # Test Unicode handling
          ./target/release/batless${{ matrix.binary_extension }} unicode_test.txt --mode=plain --max-lines=1

      - name: Test large file handling
        shell: ${{ matrix.shell }}
        run: |
          # Create a moderately large file (cross-platform compatible)
          python3 -c "for i in range(1000): print(f'line {i+1} with some content')" > large_test.txt

          # Test with various limits
          ./target/release/batless${{ matrix.binary_extension }} large_test.txt --max-lines=100 --mode=plain > /dev/null
          ./target/release/batless${{ matrix.binary_extension }} large_test.txt --max-bytes=1024 --mode=plain > /dev/null

      - name: Test error handling (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          set +e  # Don't fail on expected errors
          ./target/release/batless nonexistent.txt 2>&1 | grep -i "error" || echo "Error handling test passed"
          set -e

      - name: Test error handling (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $output = & "./target/release/batless.exe" nonexistent.txt 2>&1 | Out-String
          if ($output -match "(?i)error") { Write-Host "Error handling test passed" } else { Write-Host "Error handling test passed (no error string)" }

  integration-validation:
    name: Integration Validation
    runs-on: ubuntu-latest
    if: (inputs.test_type || 'full') == 'full'
    needs: [cross-compile-targets]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all binary artifacts
        uses: actions/download-artifact@v7
        with:
          merge-multiple: true

      - name: Validate binary artifacts
        run: |
          echo "ðŸ“¦ Validating binary artifacts..."

          # List all downloaded artifacts
          find . -name "batless*" -type f -exec ls -la {} \;

          # Check that we have binaries for expected platforms
          expected_targets=(
            "x86_64-unknown-linux-gnu"
            "x86_64-unknown-linux-musl"
            "x86_64-pc-windows-msvc"
            "x86_64-apple-darwin"
            "aarch64-apple-darwin"
          )

          for target in "${expected_targets[@]}"; do
            if find . -path "*$target*" -name "batless*" | grep -q .; then
              echo "âœ… Found binary for $target"
            else
              echo "âŒ Missing binary for $target"
              exit 1
            fi
          done

          echo "ðŸŽ¯ All expected binaries present!"

  cross-platform-report:
    name: Cross-Platform Report
    runs-on: ubuntu-latest
    if: always()
    needs:
      [cross-compile-targets, platform-specific-tests, integration-validation]

    steps:
      - name: Generate cross-platform report
        run: |
          {
            echo "# Cross-Platform Validation Report"
            echo ""
            echo "## Summary"
            echo "- Cross-Compile Targets: ${{ needs.cross-compile-targets.result }}"
            echo "- Platform-Specific Tests: ${{ needs.platform-specific-tests.result }}"
            echo "- Integration Validation: ${{ needs.integration-validation.result }}"
            echo ""
          } > report.md

          if [[ "${{ needs.cross-compile-targets.result }}" == "success" ]] && \
             [[ "${{ needs.platform-specific-tests.result }}" == "success" ]] && \
             [[ "${{ needs.integration-validation.result }}" == "success" ]]; then
            {
              echo "âœ… **All cross-platform tests passed!**"
              echo ""
              echo "The application successfully builds and runs on all target platforms."
            } >> report.md
          else
            {
              echo "âŒ **Some cross-platform tests failed.**"
              echo ""
              echo "Please review the failed jobs and address platform-specific issues."
            } >> report.md
          fi

          cat report.md

      - name: Upload report
        uses: actions/upload-artifact@v6
        with:
          name: cross-platform-report
          path: report.md
          retention-days: 30
