name: Changelog Generation

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'cliff.toml'
      - '.github/workflows/changelog.yml'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # stable
        with:
          toolchain: stable

      - name: Install git-cliff
        run: |
          cargo install git-cliff --locked

      - name: Generate changelog (unreleased)
        run: |
          # Ensure we have git history with tags
          git fetch --unshallow || true
          git fetch --tags || true
          
          # Generate changelog with better error handling
          if git cliff --config cliff.toml --unreleased --strip header > CHANGELOG_UNRELEASED.md; then
            echo "‚úÖ Generated unreleased changelog successfully"
            echo "üìÑ Preview (first 100 lines):"
            head -100 CHANGELOG_UNRELEASED.md
          else
            echo "‚ùå Failed to generate changelog"
            echo "üîç Debugging information:"
            echo "Current git status:"
            git status --porcelain
            echo "Available tags:"
            git tag -l | head -10
            echo "Recent commits:"
            git log --oneline -10
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-unreleased
          path: CHANGELOG_UNRELEASED.md
